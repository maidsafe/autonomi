# Workflow to verify release installers work correctly
#
# This workflow downloads installers from a GitHub release and verifies
# they install correctly and the binaries work as expected.
#
# Note: Currently only tests x86_64 architecture due to GitHub runner limitations.
# Cross-architecture testing (aarch64, armv7, arm) would require emulation or
# self-hosted runners, which is not implemented. The packages for other architectures
# are built but not automatically verified.
#
# Usage:
#   Run manually via Actions tab, providing the release tag to verify.

name: verify release installers

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to verify (e.g., stable-2025.12.3.3 or rc-2025.12.3.3)'
        required: true
        type: string
      package_type:
        description: 'Package type to test'
        required: true
        type: choice
        options:
          - deb
          - rpm
          - apt
        default: deb

jobs:
  verify-deb:
    if: ${{ inputs.package_type == 'deb' }}
    name: verify deb (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-musl
            runner_arch: X64
    steps:
      - name: Extract version from tag
        id: version
        run: |
          # Extract version from tag like "stable-2025.12.3.3" or "rc-2025.12.3.3"
          tag="${{ inputs.release_tag }}"
          version="${tag#*-}"
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Extracted version: $version"

      - name: Download deb package from release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          version="${{ steps.version.outputs.version }}"
          deb_file="${version}.autonomi.${{ matrix.target }}.deb"

          echo "Downloading $deb_file from release ${{ inputs.release_tag }}..."

          gh release download "${{ inputs.release_tag }}" \
            --repo ${{ github.repository }} \
            --pattern "$deb_file" \
            --pattern "$deb_file.asc"

          echo "Downloaded files:"
          ls -la

      - name: Import GPG key and verify signature
        run: |
          version="${{ steps.version.outputs.version }}"
          deb_file="${version}.autonomi.${{ matrix.target }}.deb"

          echo "Fetching Autonomi GPG signing key..."
          curl -fsSL "https://raw.githubusercontent.com/${{ github.repository }}/main/resources/keys/autonomi-signing-key.asc" | gpg --import

          echo "Verifying package signature..."
          gpg --verify "$deb_file.asc" "$deb_file"

      - name: Install deb package
        run: |
          version="${{ steps.version.outputs.version }}"
          deb_file="${version}.autonomi.${{ matrix.target }}.deb"

          echo "Installing $deb_file..."
          sudo dpkg -i "$deb_file"

      - name: Verify binaries are installed
        run: |
          echo "Checking binary locations..."

          for binary in ant antnode antctl; do
            path="/usr/local/bin/$binary"
            if [[ -x "$path" ]]; then
              echo "  $binary: OK ($path)"
            else
              echo "  $binary: MISSING or not executable"
              exit 1
            fi
          done

          echo "All binaries installed correctly"

      - name: Verify binaries execute
        run: |
          echo "Testing binary execution..."

          echo "ant --version:"
          ant --version

          echo ""
          echo "antnode --version:"
          antnode --version

          echo ""
          echo "antctl --version:"
          antctl --version

          echo ""
          echo "All binaries execute correctly"

      - name: Test basic functionality
        run: |
          echo "Testing basic functionality..."

          echo "ant --help:"
          ant --help | head -20

          echo ""
          echo "antnode --help:"
          antnode --help | head -20

          echo ""
          echo "antctl --help:"
          antctl --help | head -20

          echo ""
          echo "Basic functionality tests passed"

  verify-rpm:
    if: ${{ inputs.package_type == 'rpm' }}
    name: verify rpm (${{ matrix.target }})
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-musl
    steps:
      - name: Install required tools
        run: |
          dnf install -y gh gnupg2

      - name: Extract version from tag
        id: version
        run: |
          # Extract version from tag like "stable-2025.12.3.3" or "rc-2025.12.3.3"
          tag="${{ inputs.release_tag }}"
          version="${tag#*-}"
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Extracted version: $version"

      - name: Download rpm package from release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          version="${{ steps.version.outputs.version }}"
          rpm_file="${version}.autonomi.${{ matrix.target }}.rpm"

          echo "Downloading $rpm_file from release ${{ inputs.release_tag }}..."

          gh release download "${{ inputs.release_tag }}" \
            --repo ${{ github.repository }} \
            --pattern "$rpm_file" \
            --pattern "$rpm_file.asc"

          echo "Downloaded files:"
          ls -la

      - name: Import GPG key and verify signature
        run: |
          version="${{ steps.version.outputs.version }}"
          rpm_file="${version}.autonomi.${{ matrix.target }}.rpm"

          echo "Fetching Autonomi GPG signing key..."
          curl -fsSL "https://raw.githubusercontent.com/${{ github.repository }}/main/resources/keys/autonomi-signing-key.asc" | gpg --import

          echo "Verifying package signature..."
          gpg --verify "$rpm_file.asc" "$rpm_file"

      - name: Install rpm package
        run: |
          version="${{ steps.version.outputs.version }}"
          rpm_file="${version}.autonomi.${{ matrix.target }}.rpm"

          echo "Installing $rpm_file..."
          rpm -i "$rpm_file"

      - name: Verify binaries are installed
        run: |
          echo "Checking binary locations..."

          for binary in ant antnode antctl; do
            path="/usr/local/bin/$binary"
            if [[ -x "$path" ]]; then
              echo "  $binary: OK ($path)"
            else
              echo "  $binary: MISSING or not executable"
              exit 1
            fi
          done

          echo "All binaries installed correctly"

      - name: Verify binaries execute
        run: |
          echo "Testing binary execution..."

          echo "ant --version:"
          /usr/local/bin/ant --version

          echo ""
          echo "antnode --version:"
          /usr/local/bin/antnode --version

          echo ""
          echo "antctl --version:"
          /usr/local/bin/antctl --version

          echo ""
          echo "All binaries execute correctly"

      - name: Test basic functionality
        run: |
          echo "Testing basic functionality..."

          echo "ant --help:"
          /usr/local/bin/ant --help | head -20

          echo ""
          echo "antnode --help:"
          /usr/local/bin/antnode --help | head -20

          echo ""
          echo "antctl --help:"
          /usr/local/bin/antctl --help | head -20

          echo ""
          echo "Basic functionality tests passed"

  verify-apt:
    if: ${{ inputs.package_type == 'apt' }}
    name: verify apt repo install
    runs-on: ubuntu-latest
    steps:
      - name: Extract version from tag
        id: version
        run: |
          tag="${{ inputs.release_tag }}"
          version="${tag#*-}"
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Extracted version: $version"

      - name: Configure APT repository
        run: |
          echo "Importing Autonomi signing key..."
          curl -fsSL "https://${{ secrets.APT_REPO_DOMAIN }}/autonomi-signing-key.asc" \
            | sudo gpg --dearmor -o /usr/share/keyrings/autonomi-archive-keyring.gpg

          echo "Adding APT repository..."
          echo "deb [signed-by=/usr/share/keyrings/autonomi-archive-keyring.gpg] https://${{ secrets.APT_REPO_DOMAIN }} stable main" \
            | sudo tee /etc/apt/sources.list.d/autonomi.list

          echo "Repository configured:"
          cat /etc/apt/sources.list.d/autonomi.list

      - name: Update package lists
        run: |
          echo "Running apt-get update..."
          sudo apt-get update

          echo "Checking autonomi package is available..."
          apt-cache show autonomi

      - name: Install autonomi package
        run: |
          echo "Installing autonomi via apt-get..."
          sudo apt-get install -y autonomi

      - name: Verify installed version
        run: |
          version="${{ steps.version.outputs.version }}"
          echo "Expected version: $version"

          echo ""
          echo "Installed package version:"
          dpkg -s autonomi | grep -i version

      - name: Verify binaries are installed
        run: |
          echo "Checking binary locations..."

          for binary in ant antnode antctl; do
            path="/usr/local/bin/$binary"
            if [[ -x "$path" ]]; then
              echo "  $binary: OK ($path)"
            else
              echo "  $binary: MISSING or not executable"
              exit 1
            fi
          done

          echo "All binaries installed correctly"

      - name: Verify binaries execute
        run: |
          echo "Testing binary execution..."

          echo "ant --version:"
          ant --version

          echo ""
          echo "antnode --version:"
          antnode --version

          echo ""
          echo "antctl --version:"
          antctl --version

          echo ""
          echo "All binaries execute correctly"

      - name: Test basic functionality
        run: |
          echo "Testing basic functionality..."

          echo "ant --help:"
          ant --help | head -20

          echo ""
          echo "antnode --help:"
          antnode --help | head -20

          echo ""
          echo "antctl --help:"
          antctl --help | head -20

          echo ""
          echo "Basic functionality tests passed"

      - name: Verify upgrade path
        run: |
          echo "Testing apt-get upgrade path..."
          sudo apt-get update
          sudo apt-get upgrade -y autonomi
          echo "Upgrade check completed successfully"
