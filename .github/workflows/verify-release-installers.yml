# Workflow to verify release installers work correctly
#
# This workflow downloads installers from a GitHub release and verifies
# they install correctly and the binaries work as expected.
#
# Usage:
#   Run manually via Actions tab, providing the release tag to verify.

name: verify release installers

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to verify (e.g., stable-2025.12.3.3 or rc-2025.12.3.3)'
        required: true
        type: string
      package_type:
        description: 'Package type to test'
        required: true
        type: choice
        options:
          - deb
        default: deb

jobs:
  verify-deb:
    if: ${{ inputs.package_type == 'deb' }}
    name: verify deb (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-musl
            runner_arch: X64
    steps:
      - name: Extract version from tag
        id: version
        run: |
          # Extract version from tag like "stable-2025.12.3.3" or "rc-2025.12.3.3"
          tag="${{ inputs.release_tag }}"
          version="${tag#*-}"
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Extracted version: $version"

      - name: Download deb package from release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          version="${{ steps.version.outputs.version }}"
          deb_file="${version}.autonomi.${{ matrix.target }}.deb"

          echo "Downloading $deb_file from release ${{ inputs.release_tag }}..."

          gh release download "${{ inputs.release_tag }}" \
            --repo ${{ github.repository }} \
            --pattern "$deb_file" \
            --pattern "$deb_file.sha256"

          echo "Downloaded files:"
          ls -la

      - name: Verify checksum
        run: |
          version="${{ steps.version.outputs.version }}"
          deb_file="${version}.autonomi.${{ matrix.target }}.deb"

          echo "Verifying checksum..."
          sha256sum -c "$deb_file.sha256"

      - name: Import GPG key and verify signature
        run: |
          version="${{ steps.version.outputs.version }}"
          deb_file="${version}.autonomi.${{ matrix.target }}.deb"

          echo "Fetching Autonomi GPG signing key..."
          curl -fsSL "https://raw.githubusercontent.com/${{ github.repository }}/main/resources/keys/autonomi-signing-key.asc" | gpg --import

          echo "Verifying package signature..."
          sudo apt-get update && sudo apt-get install -y dpkg-sig
          dpkg-sig --verify "$deb_file"

      - name: Install deb package
        run: |
          version="${{ steps.version.outputs.version }}"
          deb_file="${version}.autonomi.${{ matrix.target }}.deb"

          echo "Installing $deb_file..."
          sudo dpkg -i "$deb_file"

      - name: Verify binaries are installed
        run: |
          echo "Checking binary locations..."

          for binary in ant antnode antctl; do
            path="/usr/local/bin/$binary"
            if [[ -x "$path" ]]; then
              echo "  $binary: OK ($path)"
            else
              echo "  $binary: MISSING or not executable"
              exit 1
            fi
          done

          echo "All binaries installed correctly"

      - name: Verify binaries execute
        run: |
          echo "Testing binary execution..."

          echo "ant --version:"
          ant --version

          echo ""
          echo "antnode --version:"
          antnode --version

          echo ""
          echo "antctl --version:"
          antctl --version

          echo ""
          echo "All binaries execute correctly"

      - name: Test basic functionality
        run: |
          echo "Testing basic functionality..."

          echo "ant --help:"
          ant --help | head -20

          echo ""
          echo "antnode --help:"
          antnode --help | head -20

          echo ""
          echo "antctl --help:"
          antctl --help | head -20

          echo ""
          echo "Basic functionality tests passed"
